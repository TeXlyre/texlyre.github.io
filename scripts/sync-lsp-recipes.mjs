import fs from "node:fs";
import path from "node:path";

const SRC = path.resolve("external/texlyre-lsp-recipes");
const OUT = path.resolve("docs/lsp-recipes");

// clean output
fs.rmSync(OUT, { recursive: true, force: true });
fs.mkdirSync(OUT, { recursive: true });

// YAML-safe quoting
const yamlQuote = (s) =>
    `"${String(s).replace(/\\/g, "\\\\").replace(/"/g, '\\"')}"`;

// helper
const writeDoc = (outPath, title, sourceMd, extraFrontMatter = {}) => {
    const fmLines = ["---", `title: ${yamlQuote(title)}`];

    for (const [k, v] of Object.entries(extraFrontMatter)) {
        // numbers/bools can be emitted raw; strings quoted
        const value =
            typeof v === "string" ? yamlQuote(v) : String(v);
        fmLines.push(`${k}: ${value}`);
    }

    fmLines.push("---", "", "");
    fs.mkdirSync(path.dirname(outPath), { recursive: true });
    fs.writeFileSync(outPath, fmLines.join("\n") + sourceMd, "utf8");
};

// Make the folder show nicely in autogenerated sidebar
// and make the category click go to "All Recipes"
fs.writeFileSync(
    path.join(OUT, "_category_.json"),
    JSON.stringify(
        {
            label: "LSP Recipes",
            link: { type: "doc", id: "lsp-recipes/all-recipes" },
            position: 5,
        },
        null,
        2
    ),
    "utf8"
);

// Optional short landing page (keeps a stable index route if you want it)
// You can remove this block if you don't care about /docs/lsp-recipes
writeDoc(
    path.join(OUT, "index.md"),
    "LSP Recipes",
    "See **All Recipes** for the full list.\n",
    { sidebar_position: 0 }
);

// Root README -> docs/lsp-recipes/all-recipes.md (first item under category)
writeDoc(
    path.join(OUT, "all-recipes.md"),
    "All Recipes",
    fs.readFileSync(path.join(SRC, "README.md"), "utf8"),
    { sidebar_position: 1 }
);

// recipes/*/README.md -> docs/lsp-recipes/<name>/index.md
const recipesDir = path.join(SRC, "recipes");
for (const entry of fs.readdirSync(recipesDir, { withFileTypes: true })) {
    if (!entry.isDirectory()) continue;

    const name = entry.name;
    const readmePath = path.join(recipesDir, name, "README.md");
    if (!fs.existsSync(readmePath)) continue;

    const md = fs.readFileSync(readmePath, "utf8");
    writeDoc(path.join(OUT, name, "index.md"), `Recipe: ${name}`, md, {
        sidebar_position: 10, // theyâ€™ll still be grouped; order inside is mostly alpha unless you customize further
    });
}

console.log("Synced LSP recipe docs ->", OUT);
